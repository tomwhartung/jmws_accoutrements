
 Get LAMP Sites Running
========================
LAMP as in LAM-PHP.  We do Python separately, and will not be doing it on this VM.

Ensure Required LAMP Packages Are Installed
-------------------------------------------
Many if not most or all of these LAMP packages have been already installed
[ ] Install any of the following packages that are missing:
    Commands (as root):
      dpkg-query -l 'package_name_or_regex'   ## if it's not found, it needs to be installed
                                              ## if nothing displays, it is not installed
      apt-get install -s package_name         ## Simulate installation
      apt-get install -y package_name         ## Do it without requesting confirmation
    Required packages:
      apache2
      apache2-utils
      mysql-server
[ ] Install php5 and any required accoutrements:
    References:
      http://askubuntu.com/questions/761713/how-can-i-downgrade-from-php-7-to-php-5-6-on-ubuntu-16-04
      http://askubuntu.com/questions/109404/how-do-i-install-different-upgrade-or-downgrade-php-version-in-still-supported
      https://lornajane.net/posts/2016/php-7-0-and-5-6-on-ubuntu
    All references agree that we need to add a ppa to do this
    As root:
      add-apt-repository ppa:ondrej/php
      apt-get install -y php5.6
    (Try to) install these packages, an edited version of the list of packages from the first reference:
      (http://askubuntu.com/questions/761713/how-can-i-downgrade-from-php-7-to-php-5-6-on-ubuntu-16-04)
    As root:
      apt-get install php5.6-mysql           # Installed OK
      apt-get install php-gettext            # Installed OK
      apt-get install php5.6-mbstring        # Installed OK
      apt-get install php-xdebug             # Installed OK
      apt-get install libapache2-mod-php5.6  # Already installed
      apt-get install php5.6-curl            # Installed OK
      apt-get install php5.6-gd              # Installed OK
      apt-get install php5.6-mcrypt          # Installed OK
      apt-get install php5.6-xml             # Installed OK
      apt-get install php5.6-xmlrpc          # Installed OK
[ ] Check php version currently being run on the command line on groja1:
      php -v   # PHP 7.0.8-0ubuntu0.16.04.3 (cli) ( NTS )
[ ] Check php version currently being used by apache on groja1:
    As tomh on groja1:
      # Put a copy phpinfo.php in /var/www/html/
    Access in browser:
      http://groja1/phpinfo.php
    Find the php version being used in the page
      PHP Version 7.0.8-0ubuntu0.16.04.3
[ ] Set php5.6 as the default for both apache and cli:
    As root:
      # For php in web apps
      a2dismod php7.0
      a2enmod php5.6
      service apache2 restart
      # For php-cli in the command line
      sudo ln -sfn /usr/bin/php5.6 /etc/alternatives/php
[ ] Re-check php version currently being run on the command line on groja1:
      php -v  # PHP 5.6.29-1+deb.sury.org~xenial+1 (cli)
[ ] Re-check php version currently being used by apache on groja1:
    As tomh on groja1:
      # Put a copy phpinfo.php in /var/www/html/
    Access in browser:
      http://groja1/phpinfo.php
    Find the php version being used in the page:
      PHP Version 5.6.29-1+deb.sury.org~xenial+1
[ ] Optional: to set php7.0 as the default for both apache and cli:
    As root:
      # For php in web apps
      a2dismod php5.6
      a2enmod php7.0
      service apache2 restart
      # For php-cli in the command line
      sudo ln -sfn /usr/bin/php5.6 /etc/alternatives/php
    *** If you do this be sure to
    *** set the default versions
    *** back to 5.6

Populate /var/www
-----------------
[ ] Get the seeourminds.com websites' source files in /var/www
    seeourminds.com:
      As tomh:
        Copy tar file(s) to groja1
        Unpack the one we want to use into seeourminds.com/htdocs/

Disk Space Spotcheck
--------------------
[ ] Disk Space Spotcheck:
    /: 2.5G/19G (15%)

Configure Apache
----------------
[ ] Add and update config files in /etc/apache2/sites-available as appropriate
    As root:
      cd /etc/apache2/sites-available
      mkdir RCS
      ci -l *.conf   ## "Installed version"
    For best results, copy conf files from another host and check in to RCS
    Fix ServerAlias specifications in apache2/sites-available/*.conf files
    As root:
      ci -l *.conf   ## "Copied from host xxxxx and updated for this host"
[ ] Enable mod_rewrite and php7.0, and start apache2 (as root):
    As root:
      cd /etc/apache2
      ls -al mods-*/rewrite*
      ls -al mods-*/php7.0*
      ls -al mods-*/mpm*
    If not enabled (or disabled, as in the case of mpm_event),
      run one or more of these commands as appropriate:
    As root:
      a2enmod rewrite
      a2enmod php7.0
      a2dismod mpm_event
      a2enmod mpm_prefork
[ ] Check that we have not yet enabled any sites:
    As root:
      cd /etc/apache2
      ls -al l sites*/*.conf
    Only the sites-available/000-default.conf file should be linked to
      the sites-enabled directory
[ ] Put a minimal index.html file in /var/www
    As tomh:
      vi /var/www/index.html
[ ] Restart apache and test in browser, to ensure we are good to go.
    As root:
      service apache2 stop
      service apache2 start
    Access in browser:
      http://ava
    Should see the minimal index.html file put in /var/www

Ensure Static Sites Work
------------------------
[ ] artsyvisions.com
    As root:
      a2ensite 010-artsyvisions.com.conf
      service apache2 stop
      service apache2 start
      l sites*/*.conf
    Should see the sites-available/010-artsyvisions.com.conf file linked to
      the sites-enabled directory
    Access in browser:
      http://ava.artsyvisions.com
[ ] groja.com
    As root:
      a2ensite 020-groja.com.conf
      service apache2 stop
      service apache2 start
      l sites*/*.conf
    Should see the sites-available/020-groja.com.conf file linked to
      the sites-enabled directory
    Access in browser:
      http://ava.groja.com
[ ] tomh.info
    As root:
      a2ensite 070-tomh.info.conf
      service apache2 stop
      service apache2 start
      l sites*/*.conf
    Should see the sites-available/070-tomh.info.conf file linked to
      the sites-enabled directory
    Access in browser:
      http://jane.tomh.info
So far so good, I hope.  And this is where the fun starts!

Finding the Right Copy of the Database
--------------------------------------
[ ] Databases used on barbara:
    NOTE: this is FOR REFERENCE ONLY - i.e., it is what we did LAST TIME
    groja.com & seeourminds.com:
      try using current db from lauren:
        seeourminds.com-2016_07_16-lauren.sql.gz
      try using current db from bette:
        seeourminds.com-2016_07_16-bette.sql.gz
    joomoowebsites.com: using db from bette (version 3.5.1)
        joomoowebsites.com-2016_07_16-bette-02-mobile_detect.sql.gz
    tomhartung.com: using db from bette
        tomwhartung.com-2016_07_16-bette.sql.gz

Overview of Process for CMS Sites
---------------------------------
1. Ensure it is working on barbara (or bette or lauren)
2. Copy code and db to jane
3. Ensure it works on jane
4. Cleanup: delete as many files as possible (downloads, old releases, tmp dirs., etc.)
5. Ensure it still works on jane
6. Copy code and db to ava
7. Ensure it works on ava
8. Consider cleaning up downloads, etc. on barbara as well

Ensure WordPress Site Works
---------------------------
Site: tomwhartung.com
[ ] Create and restore database
    See ~/technical/cmses/wordpress
[ ] Enable site and restart apache
    As root:
      a2ensite 080-tomwhartung.com.conf
      service apache2 stop
      service apache2 start
[ ] Edit wp-config.php and update Settings -> URLs in back end
    Chrome browser redirect issue:
      Menu -> More Tools -> Clear Browsing Data
[ ] Configure wordpress updates
    See ~/technical/cmses/wordpress/README.txt

Ensure Joomla Site Works
-------------------------
Site: joomoowebsites.com

[ ] Create and restore database
    See ~/technical/cmses/joomla
[ ] Enable site and restart apache
    As root:
      a2ensite 040-joomoowebsites.com.conf
      service apache2 stop
      service apache2 start
[ ] For joomla on a fresh install of 16.04, install simplexml:
    Check for it in phpinfo.php - it has its own section
    If it is not installed:
    As root:
       apt-get install php7.0-simplexml
       service apache2 restart
    Reference: http://forum.joomla.org/viewtopic.php?t=916040
[ ] To fix "The file Cache Storage is not supported on this platform." error:
    As root:
      cd /var/www/joomoowebsites.com/htdocs/joomoowebsites.com
      chgrp www-data cache/ administrator/cache/ tmp

Ensure Drupal Site Works
------------------------
Site: tomhartung.com
[ ] Create and restore database
    -> using version from bette
    See ~/technical/cmses/drupal
[ ] Set ownership of cache files
    As root:
      cd sites/default
      chown -R www-data:www-data files
[ ] Enable site and restart apache
    As root:
      a2ensite 060-tomhartung.com.conf
      service apache2 stop
      service apache2 start
      cd /etc/apache2
      l sites-*/*.conf
[ ] Log into back end and clear cache
    Browser:
      ava.tomhartung.com/admin -> Configuration -> Development -> Performance -> Clear all caches

Install Drush Using apt-get
+---------------------------
Tried installing this a couple of ways on jane, using composer, based on up-to-date info on docs.drush.org
Unfortunately that process did not work.
For details about steps taken on jane, see ../2016-jane-2/2-lamp_server-virtual_hosts.txt
[ ] Using apt-get:
    As tomh:
      sudo apt-get install drush
      which drush      ## /usr/bin/drush
      drush --version  ## drush version 5.10.0
[ ] Update: This version of drush does not work with Drupal 8
    For now:
      -> Use the version we installed on jane
      -> Hope that because we keep the source on github, we will not need to use it on barbara and ava
    Stay tuned for more updates

Checking the Sites:
-------------------
Checking all sites, in conjunction with getting them to work on jane and barbara:
[ ] Checking the static sites:
    [ ] artsyvisions.com
    [ ] tomh.info
[ ] Checking the WordPress site:
    [ ] tomwhartung.com
[ ] Checking the Joomla site:
    [ ] joomoowebsites.com
[ ] Checking the Drupal site:
    [ ] tomhartung.com

Back It All Up
--------------
[ ] Ensure we have backups of everything, including a copy for off-site
[ ] Set up (semi-)automatic backups as appropriate

[ ] Disk Space Spotcheck:
    /:        2.1G/22G (10%)
    /home:    0.2G/4.5G (4%)
    /var/www: 5.5G/13G (30%)

Final Steps
-----------
[ ] Update apache logs config so we can tell which site each message applies to
    Reference:
      https://www.digitalocean.com/community/tutorials/how-to-configure-logging-and-log-rotation-in-apache-on-an-ubuntu-vps
    Update all files in /etc/apache2/sites-available
    Change:
      CustomLog ${APACHE_LOG_DIR}/access.log combined
    to
      CustomLog ${APACHE_LOG_DIR}/access.log vhost_combined
    and restart apache2:
      sudo service apache2 restart
[ ] Use logrotate to rotate apache logs weekly
    Reference:
      https://serversforhackers.com/managing-logs-with-logrotate
    Ensure logrotate is installed:
      sudo dpkg-query --list '*rotate*'
    Check installed version of the logrotate conf file for apache into RCS
    As root:
      cd /etc/logrotate.d
      mkdir RCS
      ci -l apache2    ## "Installed version"
    Edit the config file as desired
      sudo vi /etc/logrotate.d/apache2
    This time we are changing it to rotate them weekly and keep a year's worth:
      "daily" -> "weekly"
      "rotate 14" -> "rotate 52"
    and adding these lines to use dates for the log file name extensions (instead of .1, .2, etc.):
      dateext
      dateformat -%Y-%m-%d-%s

********************
*** YOU ARE HERE ***
********************

Final Steps
-----------
[ ] Configure automatic wordpress updates

