#!/usr/bin/python3
#
# gitAllSites: runs a git command for all sites with code in github
# -----------------------------------------------------------------
#
import os       # for getting values for environment vars
import sys      # for accessing command line arguments
from subprocess import call  # for running commands
from os.path import isfile, isdir, islink
from os import chdir, listdir

##
#  Returns the name of the file containing a list of sites
#  If the path is NOT set in the environment,
#     use the default example file
#
def getGitSitesListFile() :
	gitSitesListFileDefault = 'gitSitesListExample.py'
	gitSitesListFileEnviron = ''
	try :
		gitSitesListFileEnviron = os.environ['GIT_SITES_LIST_FILE']
	except :
		pass
	if( gitSitesListFileEnviron == '' ) :
		gitSitesListFile = gitSitesListFileDefault
	else :
		gitSitesListFile = gitSitesListFileEnviron
	return gitSitesListFile

##
#  Checks that the specified directory exists, exiting with an error message if it doesn't
#
def verifyDirectory( dirToCheck ) :
	if isdir( dirToCheck ) :
		print( 'Found a ' + dirToCheck + ' directory, cool.' )
	else:
		print( 'Expecting a "' + dirToCheck + '" directory, but it is not here.' )
		exit( 1 )

##
# Main Routine Starts Here
# ------------------------
# Process command line arg
#
command = ''
if ( len(sys.argv) == 1 ) :
	print( 'No command specified, running "git status"' )
	command = 'status'
elif ( len(sys.argv) == 2 ) :
	command = sys.argv[1]
else :
	print( 'Too many arguments, try again.' )
	exit( 1 )

#
# Get the list of site names
#
gitSiteNames = {}
gitSitesListFile = getGitSitesListFile()
exec( compile(open(gitSitesListFile,"rb").read(), gitSitesListFile, 'exec'), globals(), locals() )
print( '=================================================================' )
print( 'Found', len(gitSiteNames), 'sites in gitSitesListFile', gitSitesListFile )

rootDir = '/var/www/'
htdocsDir = '/htdocs/'
customizationsDir = 'customizations'


for siteName in gitSiteNames :
	siteHtdocsDir = rootDir + siteName + htdocsDir
	siteCoreDir = rootDir + siteName + htdocsDir + '/' + siteName
	customizationsParentDir = rootDir + siteName + htdocsDir + customizationsDir
	gitCommand = 'git ' + command
##	print( 'siteHtdocsDir = ', siteHtdocsDir )
##	print( 'siteCoreDir = ', siteCoreDir )
##	print( 'customizationsParentDir = ', customizationsParentDir )
##	print( 'calling gitCommand = "', gitCommand, '"' )
	fullCommand = 'cd ' + siteCoreDir + '; ' + gitCommand + ' | egrep -v "^\b*$" | sed "s&^&' + siteName + ': &"'
	print( '=================================================================' )
##	print( siteName, '-', command, '(', fullCommand, ')' )
	print( siteName, '-', command )
	call( fullCommand, shell=True )
	customizations = listdir( customizationsParentDir )
	customizations.sort()
	for gitRepo in customizations:
		print( '-----------------------------------------------------------------' )
		print( gitRepo, '-', command )
		gitRepoDir = customizationsParentDir + '/' + gitRepo
		fullCommand = 'cd ' + gitRepoDir + '; ' + gitCommand + ' | egrep -v "^\b*$" | sed "s&^&' + gitRepo + ': &"'
		call( fullCommand, shell=True )

