#!/bin/bash
#
# dbRestore: restore specified site's db to backup file from specified host on specified date
# -------------------------------------------------------------------------------------------
#
function badSyntax
{
   echo 'Syntax: dbRestore all|a|j|s|t|tw|jm|jj [ -h hostname ] [ -d date ] [ password ]'
   echo '  Restores specified db from backup saved in ~tomh/backup/db'
   echo '  j = joomoowebsites.com'
   echo '  s = seeourminds.com'
   echo '  t = tomhartung.com'
   echo '  tw = tomwhartung.com'
   echo '  jm = joomoowebsites.com'
   echo '  jj = jenniferj.info'
   echo "  hostname defaults to name of current host"
   echo "  date defaults to today's date and must be in the format YYYY_MM_DD"
}

if [ $# -lt 1 ]; then
   badSyntax
   exit 1
fi

site=$1
shift

hostname=$(hostname)
date=$(date +'%Y_%m_%d')
password=''

#
#  Look for optional hostname and date in the args
#
while [ $# -gt 1 ]
do
   case $1 in
      -d)
         echo -n $2 | grep '_' > /dev/null
         grep_underscore=$?
         length=$(echo -n $2 | wc -c)
         if [ $grep_underscore -eq 0 -a $length -eq 10 ]; then
            date=$2
         else
            badSyntax
            echo
            echo "Error: specified date (\"$2\") is not in the proper format"
            echo
            exit 3
         fi
         shift 2
         ;;
      -h)
         hostname=$2
         shift 2
         ;;
   esac
done

if [ $# -eq 1 ]; then
   password=$1
fi

echo "site = \"$site\""
echo "date = \"$date\""
echo "hostname = \"$hostname\""
## echo "password = \"$password\""

ret_val=0

if [ "$site" == 'all' -o "$site" == 'a' -o "$site" == 'j' -o "$site" == 'jm' ]; then
   dbRestoreOne joomoowebsites.com $date $hostname jumlah3_joomoowebsites $password
   ret_val=$?
fi

if [ "$site" == 'all' -o "$site" == 'a' -o "$site" == 's' ]; then
   dbRestoreOne seeourminds.com $date $hostname jumlah_seeourminds $password
   ret_val=$?
fi

if [ "$site" == 'all' -o "$site" == 'a' -o "$site" == 't' ]; then
   dbRestoreOne tomhartung.com $date $hostname drpal_tomhartung $password
   ret_val=$?
fi

if [ "$site" == 'all' -o "$site" == 'a' -o "$site" == 'tw' ]; then
   dbRestoreOne tomwhartung.com $date $hostname wpress_tomwhartung $password
   ret_val=$?
fi

if [ "$site" == 'all' -o "$site" == 'a' -o "$site" == 'jj' ]; then
   dbRestoreOne jenniferj.info $date $hostname wpress_jenniferj $password
   ret_val=$?
fi

## echo "ret_val = $ret_val"

exit $ret_val
