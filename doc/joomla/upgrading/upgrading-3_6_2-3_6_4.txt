
# JooMooWebSites.com - Upgrading Notes for 2016

We're always changing this, so this file is mostly to keep track of
what was done the last time or two, in case we find issues, and to
give us a starting point, with appropriate cautions and tips, for
next time.

## Reference:

Always check out the release news:

* https://www.joomla.org/announcements/release-news.html

Sometimes special instructions apply.

## Log

2016-10-31: Upgrading from 3.6.2 to 3.6.4 .
(Unsure how we got from 3.6.0 to 3.6.2 .)

## Before You Start

Always backup db and ensure code is up-to-date and checked in.

1. On ALL hosts: backup DB and ensure code matches what is in github
   bu jm 01-before_upgrading_3.6.2_to_3.6.4
   gojmj
   git status
   git pull
2. Decide which host to do most of the work on:
   jane - our development server, with a new disk and plenty of memory, should do well

## 2016-10-31: Notes on Upgrading From 3.6.2 to 3.6.4

The Release News page links to this process:

* https://docs.joomla.org/J3.x:Updating_from_an_existing_version

Reviewing past attempts (../upgrading_in_backend_never_works.txt),
I feel like Charley Brown here, and joomla.org is Lucy holding the football.

### Not cool

1. In ../upgrading_in_backend_never_works.txt it says to access: Adminitrator -> Extensions -< Manage -> Install 

2. That page says:
"**Warning:** No installation plugin has been enabled.
At least one must be enabled to be able to use the installer.
Go to the Plugin Manager to enable the plugins."

3. Going to the Plugin Manager confirms that four installation plugins are installed and enabled.

4. Returning to the Adminitrator -> Extensions -< Manage -> Install page, it still displays that warning.  Sheesh fml.

### Observations

Aha! Checking the permissions in Step (1) it says plugins/installer is unwritable - added that to fix_permissions.sh ....

Still seeing the warning message.

Trying to edit the plugins listed (by clicking on their names), three of the four give me an error:

1. Installer - Install from Web: able to open it up, not many options to edit though

2. Installer - Install from Upload: "Error The file packageinstaller.xml could not be found."

3. Installer - Install from Folder: "Error The file folderinstaller.xml could not be found."

4. Installer - Install from URL: "Error The file folderinstaller.xml could not be found."

### The Fix!?!

Downloaded Joomla_3.6.4-Stable-Full_Package.zip and found code in the following directories:

* plugins/installer/folderinstaller/
* plugins/installer/packageinstaller/
* plugins/installer/urlinstaller/

Coped this code into the site directory tree and it fixed the errors!

### Step (1) Standard Preparatory Steps

Looking at the process recommended on joomla.org, presumably we can update using the back end.
That's what it's telling me to do.
We have fallen for that crap before.
If we are going that route, let's at least perform these preparatory steps.

1. Check and fix file permissions
   System Information -> Folder Permissions
   If one or more of these is Unwritable, run these commands and recheck:
      gojmj
      ./fix_permissions.sh   # will ask for password to run sudo commands
   To get configuration.php to show up as writable, may need to:
   o  ** TEMPORARILY ** break the link and
   o  ** TEMPORARILY ** copy the file from ../gitignored
   rm configuration.php
   cp ../gitignored/configuration.php .
   sudo chgrp www-data configuration.php
   chmod 775 configuration.php
   Recheck in back end:
      System Information -> Folder Permissions
2. Fixing warnings in Components -> Joomla Update
   Components -> Joomla Update -> Upload & Update tab has two warnings
   2.1. "the php temporary folder is not set"
     Fixed by setting the following values in /etc/php/7.0/apache2/php.ini
       sys_temp_dir = "/tmp"     ;; first try, did not fix warning, but shouldn't hurt
       upload_tmp_dir = "/tmp"   ;; second try, see reference, fixed warning
     Restart apache
     Reference: https://forum.joomla.org/viewtopic.php?t=933658
   2.2. "Maximum PHP file upload size is too small: ... both upload_max_filesize and post_max_size settings of ... php.ini"
     Fixed by setting the following value in /etc/php/7.0/apache2/php.ini
       upload_max_filesize = 8M
     Restart apache
3. Clear all caches
   Click on System -> Clear Cache
   Click on System -> Clear Expired Cache
      -> Clear Expired Cache (Icon/Button just below heading)
4. Trying Components -> Joomla Update -> Upload & Update tab
   Because jane is behind two firewalls
   Download file, put in:
     /var/www/joomoowebsites.com/downloads/Joomla_3.6.4-Stable-Update_Package.zip
   Choosing: "Write files directly" in drop-down
   Click: Upload & Install
   Doesn't do anything.
5. Trying Components -> Joomla Update -> Live Update tab (default)
   Choosing: "Write files directly" in drop-down
   It tried to do something!
   "Message: Download of update package failed."

   ************************************
   *** Sheesh what the actual fuck. ***
   ************************************

   Click on "View Updates"
   Click the "Clear Cache" button
   Click the "Find Updates" button
   Check the "Installer - Install from Web" checkbox
   Click the "Update" button
   Results:
      "Warning - JInstaller: :Install: Can't find XML setup file."
      "Message - Updating plugin was successful."
   Click the "Clear Cache" button (safety check)
   Click the "Find Updates" button
   Results:
      "No updates available"
2.2 Try again
   Trying Components -> Joomla Update
   Click the "Clear Cache" button (always try to be safe)
   Click the "Install the Update" button
   Popup: "ERROR: Invalid login"  (getting deja vu)
   Doesn't seem to be doing anything....
   Not seeing any recent posts about this....
3. This page offers three options:
   **************************************************************
   *** THIS DID NOT WORK - KEEPING FOR FUTURE REFERENCE ONLY  ***
   *** PLEASE SKIP TO STEP 4 AND IGNORE THIS MESS - THANK YOU ***
   **************************************************************
   https://docs.joomla.org/J3.x:Updating_Joomla_(Install_Method)
   They all assume I am using something like Go Daddy or CPanel
   Components -> Joomla Update
   Download zip file "Update package URL"
3.1 Unpack the zip file in /var/www/joomoowebsites.com/htdocs/unpack
   gojmh
   mkdir unpack
   cd unpack
   ls -altr ~/Downloads/
   mv ~/Downloads/Joomla_3.6.0-Stable-Update_Package.zip .
   cd ../../downloads/
   cp ../htdocs/unpack/Joomla_3.6.0-Stable-Update_Package.zip .
   cd -     # back to /var/www/joomoowebsites.com/htdocs/unpack
3.2 Install the new code
-> Trying Option 2: Install from Directory
   (Admin) -> Extensions -> Manage -> Install
   Install from folder (tab)
   Enter the following value for "Install folder:"
      /var/www/joomoowebsites.com/htdocs/unpack
   Get errors - with both the .zip file and with unzipped .zip file:
   ** Warning: JInstaller: :Install: Can't find XML setup file.
   ** Error: Path does not have a valid package.  Unable to find install package
-> Trying Option 3: Upload a Package File
   (Admin) -> Extensions -> Manage -> Install
   Upload Package File (tab)
   Browse - select downloaded file (Joomla_3.6.0-Stable-Update_Package.zip)
   Click the Upload and Install button
   ** Does not do anything except spin for a second or two max
-> Updated php.ini and fixed all warnings in:
   Extensions -> Manage -> Warnings
   ** Try Option 3 again! -> Same result
   ** Try Option 2 again! -> Same result (both zipped and unzipped)
-> Try Option 1: Install from URL
   Using URL from Components -> Joomla Update , i.e.:
      https://github.com/joomla/joomla-cms/releases/download/3.6.0/Joomla_3.6.0-Stable-Update_Package.zip
   Results: more errors!
   ** Warning: JInstaller: :Install: Can't find XML setup file.
   ** Error: Unable to find install package
   *******************************
   *** ABOVE STEP DID NOT WORK ***
   *** USING MANUAL PROCEDURE  ***
   *******************************
4. Fall back to manual procedure (as usual)
   See very bottom of this page:
      https://www.joomla.org/announcements/release-news/5666-the-joomla-3-6-1-update.html
   Refers to this page:
      https://gist.github.com/mbabker/d7bfb4e1e2fbc6b7815a733607f89281
   Process actually looks similar to what we did last time
4.1 Overview of preparatory steps (used last time and previously covered above)
   Check DB Schema: Extensions -> Manage -> Database
   Download Joomla_3.6.0-Stable-Update_Package.zip
   Fix permissions
4.2 A process similar to this worked last time:
   gojmj
   cp ../../downloads/Joomla_3.6.0-Stable-Update_Package.zip .
   unzip -o Joomla_3.6.0-Stable-Update_Package.zip
   rm Joomla_3.6.0-Stable-Update_Package.zip
   **************************
   *** DO NOT ACCESS SITE ***
   **************************
4.3 Now for the special script part - see URLs immediately above
   github gist: Download zip file from:
      https://gist.github.com/mbabker/d7bfb4e1e2fbc6b7815a733607f89281
   gojmh
   cp ~/Downloads/d7bfb4e1e2fbc6b7815a733607f89281-4f8bd9cfd2c54f853ca99bae3033586a81f9f236.zip ../downloads
   mkdir -p unpack/script/
   cp ../downloads/d7bfb4e1e2fbc6b7815a733607f89281-4f8bd9cfd2c54f853ca99bae3033586a81f9f236.zip unpack/script/
   cd unpack/script/
   unzip d7bfb4e1e2fbc6b7815a733607f89281-4f8bd9cfd2c54f853ca99bae3033586a81f9f236.zip
   l d7bfb4e1e2fbc6b7815a733607f89281-4f8bd9cfd2c54f853ca99bae3033586a81f9f236
   cp d7bfb4e1e2fbc6b7815a733607f89281-4f8bd9cfd2c54f853ca99bae3033586a81f9f236/postupdate.php ../../joomoowebsites.com
   gojmj
   mv postupdate.php administrator
4.4 Run the postupdate.php script, then remove it:
   Run it in the browser:
      jane.joomoowebsites.com/administrator/postupdate.php
   Response:
      "Update to 3.6.0 completed successfully."
   gojmj
   rm administrator/postupdate.php
4.5 Check:
   Extensions -> Manage -> Database
      "Database table structure is up to date."
   System -> System Information
      Joomla Version: 3.6.0
5. Upgrade to 3.6.2
   Note: now at 3.6.0, still need to upgrade to 3.6.2
5.1 Commit code and backup database
   gojmj
   git add --all
   gs
   gc 'Upgraded to 3.6.0.' ; gpom
   bu jm 02-before_upgrading_3.6.0_to_3.6.2
5.2 Which to use?
   Option 1: found via joomla.org/download.html:
      Joomla_3.6.x_to_3.6.2-Stable-Patch_Package.zip
   Option 2: found via Admin -> Components -> Joomla Update (-> 1st tab: Live Update)
      Joomla_3.6.2-Stable-Update_Package.zip
-> Picking option 2:
   gojmh
   cd downloads
   mv ~/Downloads/Joomla_3.6.2-Stable-Update_Package.zip .
5.3 Trying the second tab on the page:
      Components -> Joomla Update -> 2nd tab: Upload and Update
   Maybe it is the firewall that is causing the update to fail?
   Apparently not.
   Results:
   ** No error messages, does not upgrade **
5.4 Oops forgot to update the plugin!
   Extensions -> Manage -> Update
   Click the "Clear Cache" button
   Click the "Find Updates" button
   Check the "Installer - Install from Web" checkbox
   Click the "Update" button
   Results - 1st attempt:
      Copy failed:
         /var/www/joomoowebsites.com/htdocs/joomoowebsites.com/tmp/install_57c4ea4a2a024/admin/access.xml to
         /var/www/joomoowebsites.com/htdocs/joomoowebsites.com/administrator/components/com_joomlaupdate/access.xml
      JInstaller: :Install: Failed to copy file
         /var/www/joomoowebsites.com/htdocs/joomoowebsites.com/tmp/install_57c4ea4a2a024/admin/access.xml to
         /var/www/joomoowebsites.com/htdocs/joomoowebsites.com/administrator/components/com_joomlaupdate/access.xml
      Component Update: Failed to copy administrator files.
      Message: Error updating component.
   No files in /var/www/joomoowebsites.com/htdocs/joomoowebsites.com/tmp
   chmod 777 /var/www/joomoowebsites.com/htdocs/joomoowebsites.com/tmp
   Retry - same results
   *********************
   *** Well crap.... ***
   *********************
5.5 When will I learn to:
-> Skip the backend folderol and just go with downloading and unzipping the update package?
   But: will it still work without the plugin that I could not install in step 5.4?
   gojmj
   cp ../../downloads/Joomla_3.6.2-Stable-Update_Package.zip .
   unzip -o Joomla_3.6.2-Stable-Update_Package.zip
   rm Joomla_3.6.2-Stable-Update_Package.zip
   Run the post update script from:
      https://gist.github.com/mbabker/d7bfb4e1e2fbc6b7815a733607f89281
   Download a zip of the gist
   gojmh
   mv ~/Downloads/d7bfb4e1e2fbc6b7815a733607f89281-4f8bd9cfd2c54f853ca99bae3033586a81f9f236.zip unpack/
   cd unpack/
   unzip d7bfb4e1e2fbc6b7815a733607f89281-4f8bd9cfd2c54f853ca99bae3033586a81f9f236.zip
   cp d7bfb4e1e2fbc6b7815a733607f89281-4f8bd9cfd2c54f853ca99bae3033586a81f9f236/postupdate.php ~/tmp
   gojmj
   mv ~/tmp/postupdate.php administrator/
5.6 Run the postupdate.php script, then remove it:
   Run it in the browser:
      jane.joomoowebsites.com/administrator/postupdate.php
   Response:
      "Update to 3.6.2 completed successfully."
   gojmj
   rm administrator/postupdate.php
5.7 Check:
   Extensions -> Manage -> Database
      "Database table structure is up to date."
   System -> System Information
      Joomla Version: 3.6.2
6. Backup and cleanup
   gojmj
   git add --all
   gs
   gc 'Upgraded to 3.6.2.' ; gpom
   bu jm 03-after_upgrading_3.6.0_to_3.6.2
   gobu
   toBarbara joomoowebsites.com-2016_08_29-jane-03-after_upgrading_3.6.0_to_3.6.2.sql.gz
   tarHome
6.1 Replace hard copy of configuration.php with link.
   diff configuration.php ../gitignored/configuration.php
   rm configuration.php ; ln -s ../gitignored/configuration.php .
   ls -al
   cd ../gitignored/
   rd configuration.php
   ci -l configuration.php
7. Note: Updating barbara (also running Ubuntu 16.04), the new server, only

Upgrading New Production host:
------------------------------
New production host (server) is barbara.
1. Backup current DB and restore final copy of DB from jane:
   bu jm  01-before_upgrading_3.5.1_to_3.6.2          # IF NOT DONE ALREADY, DO IT NOW
   rs -h jane -d 2016_08_29 jm 03-after_upgrading_3.6.0_to_3.6.2
2. Pull the code and fix the permissions
   gojmj
   git pull
   fix_permissions.sh  # Does checking this file in pose a security risk?  I don't see how, but...
3. Ensure configuration.php matches that on jane:
   gojmj
   cd ../gitignored/
   diffJane configuration.php
4. Test in browswer
   Test front end in browser
   - Check a few menu options
   - Check articles with images
   Test back end in browser
   - System -> System Information -> System Information (check Joomla version)
   - System -> System Information -> Folder Permissions (Unwritable configuration.php is ok)
   - Extensions -> Manage -> Database (check schema version)
5. Backup DB and we are done:
   bu j  02-after_upgrade

