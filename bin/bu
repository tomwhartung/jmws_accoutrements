#!/usr/bin/python3
#
# bu: backs up a mysql database
# -----------------------------
#
def syntax() :
	print( 'Syntax: TBD TBD TBD' )

import time     # for the date string in our backup file name
import socket   # for getting the hostName
import sys      # for accessing command line arguments
from subprocess import call

hostName = socket.gethostname()

if ( len(sys.argv) == 1 ) :
	siteArg = 'all'
elif ( len(sys.argv) == 2 ) :
	siteArg = sys.argv[1]
else :
	syntax()
	print( 'Wrong number of args.' )
	exit( 1 )

#
#  Set these credential-containing globals to default values
#  The Top Secret Db File sets these to the correct secret values for our Dbs
#
dbName = ''
dbUser = ''
dbPass = ''
siteName = siteArg

#
#  Run the Top Secret Db File that contains all the credentials and sets the credential-containing globals.
#  For best results, this file should be in your home directory and have its permissions set to 700
#  Never ever ever check this top secret file in to a public repository,
#     else people will be able to hack your DB!!!!
#
topSecretDbFile = '/home/tomh/bin/dbData.py'
exec( compile(open(topSecretDbFile,"rb").read(), topSecretDbFile, 'exec'), globals(), locals() )


#
# If we don't have a password, the -p arg to mysql causes it to prompt them for it
#
if ( dbPass == '' ) :
	passwordArg = '-p'
else :
	passwordArg = '--password=' + dbPass

#
# If we don't have a specific user, we know that the root user will always be there
#
if ( dbUser == '' ) :
   dbUser = 'root'

backupDir = '~/backup/db/'
dateString = time.strftime( '-%Y_%m_%d-' )
backupFileName = backupDir + '/' + siteName + dateString + hostName + '.sql.tgz'

backupCommand = 'mysqldump --quick --opt -u ' + dbUser + ' ' + passwordArg + ' ' + dbName + ' | gzip > ' + backupFileName

print( 'siteArg = ', siteArg )
print( 'siteName = ', siteName )
print( 'dbName = ', dbName )
print( 'dbUser = ', dbUser )
print( 'dbPass = ', dbPass )
print( 'passwordArg = ', passwordArg )
print( 'hostName = ', hostName )
print( 'dateString = ', dateString )
print( 'backupFileName = ', backupFileName )
print( 'backupCommand = ', backupCommand )

print( 'Backing up DB for site', siteName, 'to', backupFileName, '...' )

call( backupCommand, shell=True )

