
Upgrading a minor version!

Details: https://www.drupal.org/node/1223018

Updated 8/1/2015 - code is now in git!!

Hosts:
[ ] bette - do all this on bette first

0. Back up db and rename the file, adding the old version number.
   buth
   gobu
   ## mv tomhartung.com-2015_08_24-bette.sql.gz tomhartung.com-2015_08_24-bette-7.XX.sql.gz
   mv tomhartung.com-2015_08_24-bette.sql.gz tomhartung.com-2015_08_24-bette-7.38.sql.gz
   toLauren tomhartung.com-2015_08_24-bette-7.38.sql.gz

1. Visit site and download tar file
   Copy to /var/www/tomhartung.com/unpack and unpack
   Move unpacked directory to /var/www/tomhartung.com/htdocs/tomhartung.com-new

2. Put into maintenance mode
   Log in as admin -> Configuration -> Maintenance Mode

3. Copy customizations into the new release area
   gothh              # cd /var/www/tomhartung.com/htdocs
   l customizations   # at this time we have nothing here
   l gitignored       # these need to be linked into the new release area

   l gitignored/sites/default      # at this time these are the files we need to link
   cd tomhartung.com/sites/sites/default
   l ../../../gitignored/sites/default
   ln -s ../../../gitignored/sites/default/files .
   ln -s ../../../gitignored/sites/default/settings.php  .

   Complete instructions are here:
      http://cgit.drupalcode.org/drupal/log/?h=7.x
   But that should be all we need to worry about right now.

4. Copy recursively the .git directory into the new release and see what has changed
   gothh
   cp -rp tomhartung.com/.git tomhartung.com-new
   cd tomhartung.com-new
   git status

5. Check for new settings
   gothh
5.1. Using git - the new way
   cd tomhartung.com-new
   gd .gitignored          # should see only "Ignore subsites" added, else will have to merge
   gd sites/default/default.settings.php   # should see no changes, else will have to merge
5.2. Use the manual/old way to double-check
   diff tomhartung.com/.gitignore tomhartung.com-new/.gitignore
   diff tomhartung.com/sites/default/default.settings.php tomhartung.com-new/sites/default/default.settings.php
5.3. Copy or merge as appropriate
   gothh
   cp tomhartung.com/.gitignore tomhartung.com-new/.gitignore
5.4. Doublecheck links:
   gothh
   l tomhartung.com-new/sites/default
   l tomhartung.com-new/sites/default/files/
   more tomhartung.com-new/sites/default/settings.php

6. Move the old directory to tomhartung.com-7.xx and new to tomhartung.com
   gothh
   ## mv tomhartung.com tomhartung.com-7.xx
   mv tomhartung.com tomhartung.com-7.38
   mv tomhartung.com-new to tomhartung.com
   l

7. Run link_subsites.py
   gothh
   link_subsites.py
   l tomhartung.com

8. Visit site to upgrade db as necessary:
   http://bette.tomhartung.com/update.php
  -> Test!!

9. If the site looks OK, commit code and backup db:
9.1. Commit and push code:
   gothd
   git status
   git add
   git commit -m 'Upgraded drupal core to version 7.39.'
   git push origin master
9.2. Remove from maintenance mode and backup DB:
   As admin -> Configuration -> "Go online."
   buth
   tarHome

Hosts:
[ ] lauren - this is a new process, make sure it works!
[ ] jane - only when the others are done and all bugs are worked out

1. Pull latest version of code from github
   gothd
   git pull

2. Restore new version of db to this host
   rsth -h bette

3. Test: verify version in admin console:
   Admin -> Reports -> Available updates

----------------------------------------

3. cp -R /var/www/tomhartung.com/unpack/drupal-7.X.Y /var/www/tomhartung.com/
###cp    /var/www/tomhartung.com/unpack/drupal-7.X.Y/.htaccess /var/www/tomhartung.com/
   diff  /var/www/tomhartung.com/unpack/drupal-7.X.Y/.htaccess /var/www/tomhartung.com/drupal-7.X.Y/.htaccess

4. Backup DB and files:
   but
   tarHome
   tarSites

***********************************************************************
********* Unsure about the precise ordering of these steps ************
*** There appear to be no database updates to run for this release  ***
*** For more information, refer to the link at the top of this page ***
***********************************************************************

5. Paranoia will destroya - but if they change one of these files, it would be good to know
   cd /var/www/tomhartung.com
   diffDrupal 7.33 7.34

6. Copy our customizations over from the current version into the new version:
   cd /var/www/tomhartung.com
   l drupal/sites/ drupal-7.34/sites
   cd  drupal/sites/ ; lf; cf ; echo ; cd ../../drupal-7.34/sites; lf; cf ; cd ../..
** cp -R drupal/sites/default/* drupal-7.34/sites/default/
OR cp -R drupal/sites/* drupal-7.34/sites/
   cd  drupal/sites/ ; lf; cf ; echo ; cd ../../drupal-7.34/sites; lf; cf ; cd ../..

7. Fix permissions:
   cd drupal-7.34/sites/
   sudo chown -R www-data:www-data default/files/
   ls -al default/files/
   cd -

8. Put site in maintenance mode
   Admin -> Configuration -> (Development) Maintenance Mode
   https://www.ostraining.com/blog/drupal/how-to-put-drupal-7-in-maintenance-mode/

9. Switch the link
   cd /var/www/tomhartung.com
   l; rm drupal; ln -s drupal-7.34 drupal; l
   cd drupal
   ln -s /var/www/resume .
   l ; cd .. ; echo ; l 

9. Visit http://bette.tomhartung.com/update.php?op=info
         http://lauren.tomhartung.com/update.php?op=info
         http://tomhartung.com/update.php?op=info
** Ensure there are no pending database updates
OR ... ... ....

10. Visit Administration -> Reports -> Status

11. Take site out of Maintenance Mode.

12. Back up DB:
    but
    tarHome

